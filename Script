-- Brookhaven Driver Speed Monitor (FINAL FIX)
-- Nick + Vel por motorista (sem espelhamento)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local billboards = {}

local function removeBillboard(player)
	if billboards[player] then
		billboards[player]:Destroy()
		billboards[player] = nil
	end
end

local function createBillboard(player, character)
	removeBillboard(player)

	local head = character:WaitForChild("Head", 5)
	if not head then return end

	local bb = Instance.new("BillboardGui")
	bb.Name = "SpeedBillboard"
	bb.Size = UDim2.new(0, 160, 0, 45)
	bb.StudsOffset = Vector3.new(0, 2.5, 0)
	bb.AlwaysOnTop = true
	bb.Enabled = false
	bb.Adornee = head
	bb.Parent = head

	local frame = Instance.new("Frame", bb)
	frame.Size = UDim2.new(1,0,1,0)
	frame.BackgroundTransparency = 1

	local nameLabel = Instance.new("TextLabel", frame)
	nameLabel.Size = UDim2.new(1,0,0.5,0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.TextScaled = true
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextColor3 = Color3.new(1,1,1)
	nameLabel.Text = player.Name

	local velLabel = Instance.new("TextLabel", frame)
	velLabel.Position = UDim2.new(0,0,0.5,0)
	velLabel.Size = UDim2.new(1,0,0.5,0)
	velLabel.BackgroundTransparency = 1
	velLabel.TextScaled = true
	velLabel.Font = Enum.Font.SourceSansBold
	velLabel.TextColor3 = Color3.new(1,1,1)
	velLabel.Text = "Vel: 0"

	billboards[player] = {
		gui = bb,
		vel = velLabel
	}
end

local function getDriverSpeed(character)
	local humanoid = character:FindFirstChildWhichIsA("Humanoid")
	if not humanoid then return nil end

	local seat = humanoid.SeatPart
	if not seat or not seat:IsA("VehicleSeat") then return nil end
	if seat.Occupant ~= humanoid then return nil end

	local car = seat:FindFirstAncestorWhichIsA("Model")
	if not car then return nil end

	for _, v in ipairs(car:GetDescendants()) do
		if v:IsA("NumberValue") and v.Name:lower():find("speed") then
			return v.Value
		end
	end

	return nil
end

-- Player handlers
local function onCharacterAdded(player, character)
	task.wait(0.5)
	createBillboard(player, character)
end

local function onPlayerAdded(player)
	player.CharacterAdded:Connect(function(char)
		onCharacterAdded(player, char)
	end)

	if player.Character then
		onCharacterAdded(player, player.Character)
	end
end

for _, p in ipairs(Players:GetPlayers()) do
	onPlayerAdded(p)
end
Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(removeBillboard)

-- Update loop
RunService.RenderStepped:Connect(function()
	for player, data in pairs(billboards) do
		local char = player.Character
		if not char then
			data.gui.Enabled = false
			continue
		end

		local speed = getDriverSpeed(char)
		if speed then
			data.gui.Enabled = true

			if speed <= 100 then
				data.vel.TextColor3 = Color3.fromRGB(255,255,255)
				data.vel.Text = "Vel: "..speed
			else
				data.vel.TextColor3 = Color3.fromRGB(255,0,0)
				data.vel.Text = "Vel: "..speed.." âš "
			end
		else
			data.gui.Enabled = false
		end
	end
end)
