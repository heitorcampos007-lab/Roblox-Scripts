-- Script para LocalScript em StarterGui ou StarterPlayerScripts

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Criar ScreenGui principal
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SpeedMonitorSystem"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Criar botão ON/OFF
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 120, 0, 50)
toggleButton.Position = UDim2.new(0.5, -60, 0.1, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
toggleButton.Text = "OFF"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.Font = Enum.Font.GothamBold
toggleButton.TextSize = 20
toggleButton.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = toggleButton

-- Estado do sistema
local isActive = false
local billboardGuis = {}

-- Função de arrastar o botão
local dragging = false
local dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    toggleButton.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

toggleButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = toggleButton.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

toggleButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Função para criar BillboardGui
local function createBillboard(character, username)
    local head = character:WaitForChild("Head")
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "SpeedDisplay"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 200, 0, 80)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    frame.BackgroundTransparency = 0.3
    frame.Parent = billboard
    
    local frameCorner = Instance.new("UICorner")
    frameCorner.CornerRadius = UDim.new(0, 8)
    frameCorner.Parent = frame
    
    local usernameLabel = Instance.new("TextLabel")
    usernameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    usernameLabel.Position = UDim2.new(0, 0, 0, 0)
    usernameLabel.BackgroundTransparency = 1
    usernameLabel.Text = username
    usernameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    usernameLabel.Font = Enum.Font.GothamBold
    usernameLabel.TextSize = 16
    usernameLabel.Parent = frame
    
    local speedLabel = Instance.new("TextLabel")
    speedLabel.Size = UDim2.new(1, 0, 0.5, 0)
    speedLabel.Position = UDim2.new(0, 0, 0.5, 0)
    speedLabel.BackgroundTransparency = 1
    speedLabel.Text = "Vel: 0"
    speedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    speedLabel.Font = Enum.Font.GothamBold
    speedLabel.TextSize = 14
    speedLabel.RichText = true
    speedLabel.Parent = frame
    
    return billboard, speedLabel
end

-- Função para verificar se jogador está dirigindo
local function isPlayerDriving(character)
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid and humanoid.SeatPart and humanoid.SeatPart:IsA("VehicleSeat") then
        return true, humanoid.SeatPart
    end
    return false, nil
end

-- Função para obter velocidade configurada
local function getConfiguredSpeed(vehicleSeat)
    -- Procura por valores de velocidade no VehicleSeat ou em seus ancestrais
    local speedValue = vehicleSeat:FindFirstChild("MaxSpeed") or vehicleSeat:FindFirstChild("Speed")
    
    if speedValue and (speedValue:IsA("NumberValue") or speedValue:IsA("IntValue")) then
        return speedValue.Value
    end
    
    -- Se não encontrar, usa a propriedade padrão MaxSpeed do VehicleSeat
    return vehicleSeat.MaxSpeed or 0
end

-- Loop principal de monitoramento
RunService.RenderStepped:Connect(function()
    if not isActive then return end
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        local character = otherPlayer.Character
        
        if character then
            local isDriving, vehicleSeat = isPlayerDriving(character)
            
            if isDriving then
                -- Criar billboard se não existir
                if not billboardGuis[otherPlayer.UserId] then
                    local billboard, speedLabel = createBillboard(character, otherPlayer.Name)
                    billboardGuis[otherPlayer.UserId] = {billboard = billboard, label = speedLabel}
                end
                
                -- Atualizar velocidade
                local speed = getConfiguredSpeed(vehicleSeat)
                local speedLabel = billboardGuis[otherPlayer.UserId].label
                
                if speed > 100 then
                    speedLabel.Text = '<font color="rgb(255,255,255)">Vel: </font><font color="rgb(255,50,50)">' .. math.floor(speed) .. ' ⚠️</font>'
                else
                    speedLabel.Text = '<font color="rgb(255,255,255)">Vel: </font><font color="rgb(50,255,50)">' .. math.floor(speed) .. '</font>'
                end
            else
                -- Remover billboard se não está dirigindo
                if billboardGuis[otherPlayer.UserId] then
                    billboardGuis[otherPlayer.UserId].billboard:Destroy()
                    billboardGuis[otherPlayer.UserId] = nil
                end
            end
        end
    end
end)

-- Função de toggle
toggleButton.MouseButton1Click:Connect(function()
    isActive = not isActive
    
    if isActive then
        toggleButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        toggleButton.Text = "ON"
    else
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        toggleButton.Text = "OFF"
        
        -- Remover todos os billboards
        for _, data in pairs(billboardGuis) do
            if data.billboard then
                data.billboard:Destroy()
            end
        end
        billboardGuis = {}
    end
end)

-- Limpeza ao remover jogadores
Players.PlayerRemoving:Connect(function(removedPlayer)
    if billboardGuis[removedPlayer.UserId] then
        billboardGuis[removedPlayer.UserId].billboard:Destroy()
        billboardGuis[removedPlayer.UserId] = nil
    end
end)
