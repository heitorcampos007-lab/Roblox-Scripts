-- CONFIG
local DEFAULT_LIMIT = 100
local UPDATE_RATE = 0.15

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- STATE
local enabled = false
local speedLimit = DEFAULT_LIMIT
local tags = {}

-- UI PANEL
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "SpeedRadarGUI"

local panel = Instance.new("Frame", gui)
panel.Size = UDim2.fromOffset(220, 130)
panel.Position = UDim2.fromOffset(100, 100)
panel.BackgroundColor3 = Color3.fromRGB(25,25,25)
panel.BorderSizePixel = 0
panel.Active = true
panel.Draggable = true

local toggle = Instance.new("TextButton", panel)
toggle.Size = UDim2.fromOffset(200, 35)
toggle.Position = UDim2.fromOffset(10, 10)
toggle.Text = "OFF"
toggle.BackgroundColor3 = Color3.fromRGB(150,0,0)
toggle.TextColor3 = Color3.new(1,1,1)

local box = Instance.new("TextBox", panel)
box.Size = UDim2.fromOffset(200, 35)
box.Position = UDim2.fromOffset(10, 55)
box.PlaceholderText = "Limite (ex: 100)"
box.Text = tostring(speedLimit)
box.BackgroundColor3 = Color3.fromRGB(40,40,40)
box.TextColor3 = Color3.new(1,1,1)

-- UI EVENTS
toggle.MouseButton1Click:Connect(function()
	enabled = not enabled
	toggle.Text = enabled and "ON" or "OFF"
	toggle.BackgroundColor3 = enabled and Color3.fromRGB(0,150,0) or Color3.fromRGB(150,0,0)
end)

box.FocusLost:Connect(function()
	local v = tonumber(box.Text)
	if v then speedLimit = v end
end)

-- TAG CREATION
local function createTag(player)
	local bb = Instance.new("BillboardGui")
	bb.Size = UDim2.fromOffset(200, 50)
	bb.StudsOffset = Vector3.new(0, 3, 0)
	bb.AlwaysOnTop = true

	local label = Instance.new("TextLabel", bb)
	label.Size = UDim2.fromScale(1,1)
	label.BackgroundTransparency = 1
	label.TextScaled = true
	label.Font = Enum.Font.SourceSansBold
	label.TextColor3 = Color3.new(1,1,1)

	tags[player] = {gui = bb, label = label}
end

local function removeTag(player)
	if tags[player] then
		tags[player].gui:Destroy()
		tags[player] = nil
	end
end

-- SPEED DETECTION
local function getDriverSpeed(player)
	local char = player.Character
	if not char then return end

	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then return end

	local seat = hum.SeatPart
	if not seat or not seat:IsA("VehicleSeat") then return end

	local vehicle = seat:FindFirstAncestorOfClass("Model")
	if not vehicle or not vehicle.PrimaryPart then return end

	return vehicle.PrimaryPart.AssemblyLinearVelocity.Magnitude
end

-- MAIN LOOP
RunService.Heartbeat:Connect(function()
	if not enabled then
		for _, data in pairs(tags) do
			data.gui.Parent = nil
		end
		return
	end

	for _, player in ipairs(Players:GetPlayers()) do
		if not tags[player] then
			createTag(player)
		end

		local data = tags[player]
		local char = player.Character
		if not char or not char:FindFirstChild("Head") then
			data.gui.Parent = nil
			continue
		end

		local speed = getDriverSpeed(player)
		if not speed then
			data.gui.Parent = nil
			continue
		end

		local textColor = Color3.fromRGB(0,255,0)
		local warn = ""

		if speed > speedLimit then
			textColor = Color3.fromRGB(255,0,0)
			warn = " ⚠️"
		end

		data.label.Text =
			player.Name .. "\n" ..
			"Vel: " .. math.floor(speed) .. warn

		data.label.TextColor3 = textColor
		data.gui.Parent = char.Head
	end
end)

-- CLEANUP
Players.PlayerRemoving:Connect(removeTag)
