--// Serviços
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

--// Configurações
local showSpeed = true -- ON/OFF inicial

--// Função pra criar BillboardGui
local function createSpeedGui(player, speedText)
    local gui = Instance.new("BillboardGui")
    gui.Name = "SpeedGui"
    gui.Adornee = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    gui.Size = UDim2.new(0, 150, 0, 50)
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.AlwaysOnTop = true

    local textLabel = Instance.new("TextLabel")
    textLabel.Name = "SpeedLabel"
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1,1,1)
    textLabel.TextStrokeTransparency = 0.5
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextScaled = true
    textLabel.Text = speedText
    textLabel.Parent = gui

    gui.Parent = player.Character
    return gui, textLabel
end

--// Função pra pegar velocidade do carro
local function getCarSpeed(player)
    if not player.Character then return 0 end
    local humanoid = player.Character:FindFirstChildWhichIsA("Humanoid")
    if not humanoid then return 0 end
    local seat = humanoid.SeatPart
    if not seat then return 0 end
    local carModel = seat:FindFirstAncestorWhichIsA("Model")
    if not carModel or not carModel.PrimaryPart then return 0 end

    local velocity = carModel.PrimaryPart.Velocity
    local speed = velocity.Magnitude
    return speed
end

--// Função pra atualizar GUI
local function updateSpeedGui(player, gui, textLabel)
    RunService.RenderStepped:Connect(function()
        if not showSpeed then
            textLabel.Text = ""
            return
        end

        local speed = getCarSpeed(player)
        if speed <= 0 then
            textLabel.Text = ""
        else
            local color = Color3.new(0,1,0) -- verde
            local emoji = ""
            if speed > 100 then
                color = Color3.new(1,0,0) -- vermelho
                emoji = " ⚠️"
            end
            textLabel.TextColor3 = color
            textLabel.Text = player.Name.." | vel: "..math.floor(speed)..emoji
        end
    end)
end

--// Criar GUI pra cada jogador
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(char)
        wait(0.5) -- esperar HumanoidRootPart carregar
        local gui, textLabel = createSpeedGui(player, "")
        updateSpeedGui(player, gui, textLabel)
    end)
end)

--// GUI ON/OFF via comando simples
game.ReplicatedStorage:WaitForChild("ToggleSpeedScript").OnServerEvent:Connect(function(player)
    showSpeed = not showSpeed
end)
