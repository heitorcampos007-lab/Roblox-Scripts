-- Versão mais resiliente para executores (Delta)
-- Tenta diferentes parents para GUIs (PlayerGui, gethui(), CoreGui) e usa proteção se disponível.
-- Mostra Billboards apenas para jogadores que ESTÃO DIRIGINDO (VehicleSeat.Occupant = Humanoid).
-- Testado para rodar via executor; se não executar, cole aqui o erro do executor.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Espera LocalPlayer
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
	repeat
		Players.PlayerAdded:Wait()
		LocalPlayer = Players.LocalPlayer
	until LocalPlayer
end

-- Helpers do executor (se existirem)
local _gethui = (type(gethui) == "function") and gethui
if not _gethui and type(syn) == "table" and type(syn.get_hui) == "function" then
	_gethui = syn.get_hui
end

local _protect = (type(syn) == "table" and type(syn.protect_gui) == "function") and syn.protect_gui
if not _protect and type(protect_gui) == "function" then
	_protect = protect_gui
end

-- Determina onde parentar GUIs: PlayerGui > gethui() > CoreGui
local function chooseGuiParent()
	-- 1) PlayerGui (ideal)
	local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
	if playerGui and playerGui.Parent then
		return playerGui, "PlayerGui"
	end
	-- 2) gethui() (hooked UI by many executors)
	if _gethui then
		local ok, gui = pcall(_gethui)
		if ok and gui then
			return gui, "gethui()"
		end
	end
	-- 3) CoreGui (last resort)
	local ok, core = pcall(function() return game:GetService("CoreGui") end)
	if ok and core then
		return core, "CoreGui"
	end
	return nil, "none"
end

local GuiParent, parentSource = chooseGuiParent()
print("[SpeedHUD] GUI parent selecionado:", parentSource, GuiParent and GuiParent.ClassName or "nil")

-- Se houver função de proteção, tenta proteger o parent (alguns executores exigem)
if _protect and GuiParent then
	pcall(function() _protect(GuiParent) end)
	print("[SpeedHUD] protect_gui aplicado")
end

-- Tabela de billboards
local billboards = {} -- player -> { gui, nameLabel, speedLabel, seat, vehicle, speedCache }

-- Config
local REFRESH_INTERVAL = 0.6
local MAX_DISTANCE = 300
local STUDS_OFFSET = Vector3.new(0, 3, 0)
local COLOR_GREEN = Color3.fromRGB(76,175,80)
local COLOR_RED = Color3.fromRGB(244,67,54)
local COLOR_WHITE = Color3.fromRGB(255,255,255)

-- Utils de busca de velocidade definida no veículo
local function findNumberValueSpeed(model)
	if not model then return nil end
	local common = {"Speed","MaxSpeed","VehicleSpeed","CarSpeed","TopSpeed","MaxVelocity","SpeedValue","DriveSpeed"}
	for _,n in ipairs(common) do
		local status, nv = pcall(function() return model:FindFirstChild(n, true) end)
		if status and nv and nv:IsA("NumberValue") then return nv end
	end
	for _,desc in ipairs(model:GetDescendants()) do
		if desc:IsA("NumberValue") then
			if string.find(desc.Name:lower(), "speed") then
				return desc
			end
		end
	end
	return nil
end

local function getVehicleFromSeat(seat)
	if not seat then return nil end
	local node = seat
	while node and node ~= Workspace do
		if node:IsA("Model") then return node end
		node = node.Parent
	end
	return nil
end

-- Cria billboard simples (somente textos transparentes)
local function createBillboardForDriver(player, seatPart)
	if not GuiParent then
		warn("[SpeedHUD] GuiParent indisponível, não foi possível criar GUI.")
		return nil
	end
	if billboards[player] and billboards[player].gui and billboards[player].gui.Parent then
		-- atualizar adornee se mudou
		local d = billboards[player]
		d.seat = seatPart
		d.vehicle = getVehicleFromSeat(seatPart)
		d.gui.Adornee = seatPart
		d.speedCache = nil
		return d
	end

	local guiName = "SpeedHUD_" .. tostring(player.UserId or player.Name)
	local ok, billboard = pcall(function()
		local b = Instance.new("BillboardGui")
		b.Name = guiName
		b.Size = UDim2.new(0, 170, 0, 48)
		b.StudsOffset = STUDS_OFFSET
		b.MaxDistance = MAX_DISTANCE
		b.AlwaysOnTop = true
		b.Adornee = seatPart
		b.Parent = GuiParent
		return b
	end)
	if not ok then
		warn("[SpeedHUD] falha ao criar BillboardGui:", billboard)
		return nil
	end

	local nameLabel = Instance.new("TextLabel")
	nameLabel.BackgroundTransparency = 1
	nameLabel.Size = UDim2.new(1, -6, 0.5, -2)
	nameLabel.Position = UDim2.new(0, 3, 0, 0)
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = 18
	nameLabel.TextScaled = true
	nameLabel.TextColor3 = COLOR_WHITE
	nameLabel.TextStrokeTransparency = 0.7
	nameLabel.Text = player.DisplayName or player.Name
	nameLabel.Parent = billboard

	local speedLabel = Instance.new("TextLabel")
	speedLabel.BackgroundTransparency = 1
	speedLabel.Size = UDim2.new(1, -6, 0.5, -2)
	speedLabel.Position = UDim2.new(0, 3, 0.5, 0)
	speedLabel.Font = Enum.Font.SourceSans
	speedLabel.TextSize = 18
	speedLabel.TextScaled = true
	speedLabel.TextColor3 = COLOR_WHITE
	speedLabel.TextStrokeTransparency = 0.7
	speedLabel.Text = "Vel: 0"
	speedLabel.Parent = billboard

	local data = {
		gui = billboard;
		nameLabel = nameLabel;
		speedLabel = speedLabel;
		seat = seatPart;
		vehicle = getVehicleFromSeat(seatPart);
		speedCache = nil;
	}
	billboards[player] = data
	return data
end

local function removeBillboard(player)
	local d = billboards[player]
	if d and d.gui then
		pcall(function() d.gui:Destroy() end)
	end
	billboards[player] = nil
end

local function getVehicleDefinedSpeed(data)
	if not data then return nil end
	-- cache
	if data.speedCache then
		local c = data.speedCache
		if c.type == "NumberValue" and c.obj and c.obj.Parent then
			return c.obj.Value
		elseif c.type == "Attribute" and data.vehicle and data.vehicle:GetAttribute(c.key) ~= nil then
			return data.vehicle:GetAttribute(c.key)
		end
		data.speedCache = nil
	end
	local vehicle = data.vehicle
	local seat = data.seat
	if vehicle then
		local nv = findNumberValueSpeed(vehicle)
		if nv then
			data.speedCache = { type = "NumberValue", obj = nv }
			return nv.Value
		end
		if vehicle.GetAttributes then
			for k,v in pairs(vehicle:GetAttributes()) do
				if type(v) == "number" and string.find(k:lower(), "speed") then
					data.speedCache = { type = "Attribute", key = k }
					return v
				end
			end
		end
	end
	if seat then
		for _,c in ipairs(seat:GetChildren()) do
			if c:IsA("NumberValue") and string.find(c.Name:lower(), "speed") then
				data.speedCache = { type = "NumberValue", obj = c }
				return c.Value
			end
		end
		if seat.GetAttributes then
			for k,v in pairs(seat:GetAttributes()) do
				if type(v) == "number" and string.find(k:lower(), "speed") then
					data.speedCache = { type = "Attribute", key = k }
					return v
				end
			end
		end
	end
	return nil
end

local function isPlayerDriving(player)
	if not player then return false end
	local char = player.Character
	if not char then return false end
	local humanoid = char:FindFirstChildOfClass("Humanoid")
	if not humanoid then return false end
	local seat = humanoid.SeatPart
	if not seat then return false end
	if not seat:IsA("VehicleSeat") then return false end
	if seat.Occupant ~= humanoid then return false end
	return true, seat
end

-- Atualiza criação/remoção de guis
local refreshTimer = 0
local function refreshBillboardsForAllPlayers()
	for _,player in ipairs(Players:GetPlayers()) do
		local ok, res = pcall(isPlayerDriving, player)
		if ok and res then
			-- res é seat
			if not billboards[player] then
				createBillboardForDriver(player, res)
			else
				local d = billboards[player]
				if d.seat ~= res then
					d.seat = res
					d.vehicle = getVehicleFromSeat(res)
					if d.gui then d.gui.Adornee = res end
					d.speedCache = nil
				end
			end
		else
			if billboards[player] then removeBillboard(player) end
		end
	end
end

-- Atualiza text das velocidades por frame
local function updateSpeeds()
	for player, data in pairs(billboards) do
		if not data or not data.gui then
			removeBillboard(player)
		else
			local displayed = 0
			local ok, vehSpeed = pcall(getVehicleDefinedSpeed, data)
			if ok and type(vehSpeed) == "number" then
				displayed = math.floor(vehSpeed + 0.5)
			else
				-- fallback seat/HRP velocity
				local speedVal = 0
				if data.seat and data.seat:IsA("BasePart") then
					local vel = data.seat.AssemblyLinearVelocity or data.seat.Velocity or Vector3.new()
					speedVal = vel.Magnitude
				else
					if player.Character then
						local hrp = player.Character:FindFirstChild("HumanoidRootPart") or player.Character:FindFirstChild("Torso")
						if hrp then
							local vel = hrp.AssemblyLinearVelocity or hrp.Velocity or Vector3.new()
							speedVal = vel.Magnitude
						end
					end
				end
				displayed = math.floor(speedVal + 0.5)
			end

			if displayed >= 1 and displayed <= 100 then
				data.speedLabel.TextColor3 = COLOR_GREEN
				data.speedLabel.Text = "Vel: " .. tostring(displayed)
			elseif displayed >= 101 then
				data.speedLabel.TextColor3 = COLOR_RED
				data.speedLabel.Text = "Vel: " .. tostring(displayed) .. " ⚠️"
			else
				data.speedLabel.TextColor3 = COLOR_WHITE
				data.speedLabel.Text = "Vel: 0"
			end
		end
	end
end

-- Toggle simples: cria botão na tela para ligar/desligar (tenta parentar no GuiParent)
local enabled = true
local function createToggleButton()
	if not GuiParent then return end
	local ok, screenGui = pcall(function()
		local sg = Instance.new("ScreenGui")
		sg.Name = "SpeedHUD_Toggle"
		sg.ResetOnSpawn = false
		sg.Parent = GuiParent
		return sg
	end)
	if not ok or not screenGui then return end

	local btn = Instance.new("TextButton")
	btn.Name = "SpeedToggleButton"
	btn.Size = UDim2.new(0,140,0,44)
	btn.Position = UDim2.new(1, -154, 0, 10)
	btn.AnchorPoint = Vector2.new(0,0)
	btn.BackgroundTransparency = 0.3
	btn.BackgroundColor3 = Color3.fromRGB(30,30,30)
	btn.BorderSizePixel = 0
	btn.TextColor3 = Color3.fromRGB(255,255,255)
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 18
	btn.Text = "Speed: ON"
	btn.Parent = screenGui

	btn.MouseButton1Click:Connect(function()
		enabled = not enabled
		btn.Text = enabled and "Speed: ON" or "Speed: OFF"
		-- show/hide todas as GUIs
		for _,d in pairs(billboards) do
			if d and d.gui then
				d.gui.Enabled = enabled
			end
		end
	end)
end

-- Loop principal
RunService.RenderStepped:Connect(function(dt)
	if not GuiParent then return end
	if not enabled then return end
	refreshTimer = refreshTimer + dt
	if refreshTimer >= REFRESH_INTERVAL then
		refreshTimer = 0
		pcall(refreshBillboardsForAllPlayers)
	end
	pcall(updateSpeeds)
end)

-- Inicializar
createToggleButton()
pcall(refreshBillboardsForAllPlayers)

print("[SpeedHUD] iniciado. GUI parent:", parentSource)
if not GuiParent then
	warn("[SpeedHUD] Nenhum GuiParent disponível. Se estiver usando executor no celular, tente executar novamente ou me envie o erro do executor.")
end
